// Generated by CoffeeScript 1.12.6
var FacebookMoLo;

FacebookMoLo = (function() {
  FacebookMoLo.prototype.fbCallbackParam = 'fbauthcallback=1';

  function FacebookMoLo(facebook, appId, scope1, rerequest) {
    this.facebook = facebook;
    this.appId = appId;
    this.scope = scope1;
    this.rerequest = rerequest != null ? rerequest : false;
  }

  FacebookMoLo.prototype.isSuccessfulCallback = function(uri) {
    if (uri == null) {
      uri = null;
    }
    if (uri === null) {
      uri = window.location.href;
    }
    return new RegExp(this.fbCallbackParam).test(window.location.href) && /error=/.test(uri) === false;
  };

  FacebookMoLo.prototype.authenticate = function(callback, redirectUri) {
    if (redirectUri == null) {
      redirectUri = null;
    }
    if (redirectUri === null) {
      redirectUri = window.location.href;
    }
    return this.facebook.getLoginStatus((function(_this) {
      return function(authResponse) {
        if (authResponse && authResponse.status === 'connected') {
          _this.facebook.api('/me/permissions', function(response) {
            var i, item, j, len, len1, permissions, reLogin, ref, ref1, scope;
            permissions = {};
            reLogin = false;
            if (typeof response.data) {
              ref = response.data;
              for (i = 0, len = ref.length; i < len; i++) {
                item = ref[i];
                if (item.status === 'granted') {
                  permissions[item.permission] = item.status;
                }
              }
            }
            ref1 = _this.scope.split(',');
            for (j = 0, len1 = ref1.length; j < len1; j++) {
              scope = ref1[j];
              if (typeof permissions[scope] === 'undefined') {
                reLogin = true;
              }
            }
            if (reLogin === false) {
              return callback(authResponse);
            }
            return _this.login(redirectUri);
          });
          return;
        }
        return _this.login(redirectUri);
      };
    })(this));
  };

  FacebookMoLo.prototype.login = function(redirectUri) {
    var href, queryParams, redirect;
    redirect = document.createElement('a');
    redirect.href = redirectUri;
    queryParams = [];
    if (/\?/.test(redirect.search) === true) {
      queryParams = redirect.search.replace('?', '').split('&');
    }
    queryParams.push(this.fbCallbackParam);
    redirect.search = '?' + queryParams.join('&');
    href = "https://m.facebook.com/dialog/oauth?" + "client_id=" + this.appId + "&scope=" + this.scope + "&redirect_uri=" + encodeURIComponent(redirect.href);
    if (this.rerequest === true) {
      href = href + "&auth_type=rerequest";
    }
    return window.location.href = href;
  };

  return FacebookMoLo;

})();
